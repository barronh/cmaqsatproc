<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cmaqsatproc.readers.tropomi &#8212; cmaqsatproc &#39;0.5.2&#39;
 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <script src="../../../_static/documentation_options.js?v=6a8ba589"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cmaqsatproc.readers.tropomi</h1><div class="highlight"><pre>
<span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;TropOMI&#39;</span><span class="p">,</span> <span class="s1">&#39;S5P_L2__NO2___&#39;</span><span class="p">,</span> <span class="s1">&#39;S5P_L2__CO____&#39;</span><span class="p">,</span> <span class="s1">&#39;S5P_L2__HCHO__&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S5P_L2__CH4___&#39;</span>
<span class="p">]</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..core</span><span class="w"> </span><span class="kn">import</span> <span class="n">satellite</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="c1"># Hard-coded to match current TropOMI implementation. This allows users</span>
<span class="c1"># to process less data.</span>
<span class="n">tm5_constant_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">0.0000000e+00</span><span class="p">,</span> <span class="mf">2.2835938e+01</span><span class="p">,</span> <span class="mf">4.2441406e+02</span><span class="p">,</span> <span class="mf">1.3875469e+03</span><span class="p">,</span>
     <span class="mf">3.0572656e+03</span><span class="p">,</span> <span class="mf">5.5643828e+03</span><span class="p">,</span> <span class="mf">8.1633750e+03</span><span class="p">,</span> <span class="mf">1.1901340e+04</span><span class="p">,</span>
     <span class="mf">1.4898453e+04</span><span class="p">,</span> <span class="mf">1.7471840e+04</span><span class="p">,</span> <span class="mf">1.9290227e+04</span><span class="p">,</span> <span class="mf">2.0361816e+04</span><span class="p">,</span>
     <span class="mf">2.0337863e+04</span><span class="p">,</span> <span class="mf">1.9859391e+04</span><span class="p">,</span> <span class="mf">1.9031289e+04</span><span class="p">,</span> <span class="mf">1.8308434e+04</span><span class="p">,</span>
     <span class="mf">1.7008789e+04</span><span class="p">,</span> <span class="mf">1.5508257e+04</span><span class="p">,</span> <span class="mf">1.3881331e+04</span><span class="p">,</span> <span class="mf">1.2766873e+04</span><span class="p">,</span>
     <span class="mf">1.1116662e+04</span><span class="p">,</span> <span class="mf">9.5626826e+03</span><span class="p">,</span> <span class="mf">8.6085254e+03</span><span class="p">,</span> <span class="mf">7.3118691e+03</span><span class="p">,</span>
     <span class="mf">6.1560742e+03</span><span class="p">,</span> <span class="mf">4.4908174e+03</span><span class="p">,</span> <span class="mf">3.3817437e+03</span><span class="p">,</span> <span class="mf">2.2654316e+03</span><span class="p">,</span>
     <span class="mf">1.4237701e+03</span><span class="p">,</span> <span class="mf">8.2396783e+02</span><span class="p">,</span> <span class="mf">4.2759250e+02</span><span class="p">,</span> <span class="mf">1.9133856e+02</span><span class="p">,</span>
     <span class="mf">6.9520576e+01</span><span class="p">,</span> <span class="mf">1.8608931e+01</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.2835938e+01</span><span class="p">,</span> <span class="mf">4.2441406e+02</span><span class="p">,</span> <span class="mf">1.3875469e+03</span><span class="p">,</span> <span class="mf">3.0572656e+03</span><span class="p">,</span>
     <span class="mf">5.5643828e+03</span><span class="p">,</span> <span class="mf">8.1633750e+03</span><span class="p">,</span> <span class="mf">1.1901340e+04</span><span class="p">,</span> <span class="mf">1.4898453e+04</span><span class="p">,</span>
     <span class="mf">1.7471840e+04</span><span class="p">,</span> <span class="mf">1.9290227e+04</span><span class="p">,</span> <span class="mf">2.0361816e+04</span><span class="p">,</span> <span class="mf">2.0337863e+04</span><span class="p">,</span>
     <span class="mf">1.9859391e+04</span><span class="p">,</span> <span class="mf">1.9031289e+04</span><span class="p">,</span> <span class="mf">1.8308434e+04</span><span class="p">,</span> <span class="mf">1.7008789e+04</span><span class="p">,</span>
     <span class="mf">1.5508257e+04</span><span class="p">,</span> <span class="mf">1.3881331e+04</span><span class="p">,</span> <span class="mf">1.2766873e+04</span><span class="p">,</span> <span class="mf">1.1116662e+04</span><span class="p">,</span>
     <span class="mf">9.5626826e+03</span><span class="p">,</span> <span class="mf">8.6085254e+03</span><span class="p">,</span> <span class="mf">7.3118691e+03</span><span class="p">,</span> <span class="mf">6.1560742e+03</span><span class="p">,</span>
     <span class="mf">4.4908174e+03</span><span class="p">,</span> <span class="mf">3.3817437e+03</span><span class="p">,</span> <span class="mf">2.2654316e+03</span><span class="p">,</span> <span class="mf">1.4237701e+03</span><span class="p">,</span>
     <span class="mf">8.2396783e+02</span><span class="p">,</span> <span class="mf">4.2759250e+02</span><span class="p">,</span> <span class="mf">1.9133856e+02</span><span class="p">,</span> <span class="mf">6.9520576e+01</span><span class="p">,</span>
     <span class="mf">1.8608931e+01</span><span class="p">,</span> <span class="mf">0.0000000e+00</span><span class="p">]</span>
<span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">tm5_constant_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">1.00000e+00</span><span class="p">,</span> <span class="mf">9.91984e-01</span><span class="p">,</span> <span class="mf">9.69513e-01</span><span class="p">,</span> <span class="mf">9.31881e-01</span><span class="p">,</span> <span class="mf">8.73929e-01</span><span class="p">,</span>
     <span class="mf">7.90717e-01</span><span class="p">,</span> <span class="mf">7.04669e-01</span><span class="p">,</span> <span class="mf">5.76692e-01</span><span class="p">,</span> <span class="mf">4.66003e-01</span><span class="p">,</span> <span class="mf">3.58254e-01</span><span class="p">,</span>
     <span class="mf">2.63242e-01</span><span class="p">,</span> <span class="mf">1.68910e-01</span><span class="p">,</span> <span class="mf">1.11505e-01</span><span class="p">,</span> <span class="mf">7.79580e-02</span><span class="p">,</span> <span class="mf">5.17730e-02</span><span class="p">,</span>
     <span class="mf">3.80260e-02</span><span class="p">,</span> <span class="mf">2.23550e-02</span><span class="p">,</span> <span class="mf">1.18060e-02</span><span class="p">,</span> <span class="mf">5.37800e-03</span><span class="p">,</span> <span class="mf">2.85700e-03</span><span class="p">,</span>
     <span class="mf">8.90000e-04</span><span class="p">,</span> <span class="mf">1.99000e-04</span><span class="p">,</span> <span class="mf">5.90000e-05</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span>
     <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span>
     <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">9.91984e-01</span><span class="p">,</span> <span class="mf">9.69513e-01</span><span class="p">,</span> <span class="mf">9.31881e-01</span><span class="p">,</span> <span class="mf">8.73929e-01</span><span class="p">,</span> <span class="mf">7.90717e-01</span><span class="p">,</span>
     <span class="mf">7.04669e-01</span><span class="p">,</span> <span class="mf">5.76692e-01</span><span class="p">,</span> <span class="mf">4.66003e-01</span><span class="p">,</span> <span class="mf">3.58254e-01</span><span class="p">,</span> <span class="mf">2.63242e-01</span><span class="p">,</span>
     <span class="mf">1.68910e-01</span><span class="p">,</span> <span class="mf">1.11505e-01</span><span class="p">,</span> <span class="mf">7.79580e-02</span><span class="p">,</span> <span class="mf">5.17730e-02</span><span class="p">,</span> <span class="mf">3.80260e-02</span><span class="p">,</span>
     <span class="mf">2.23550e-02</span><span class="p">,</span> <span class="mf">1.18060e-02</span><span class="p">,</span> <span class="mf">5.37800e-03</span><span class="p">,</span> <span class="mf">2.85700e-03</span><span class="p">,</span> <span class="mf">8.90000e-04</span><span class="p">,</span>
     <span class="mf">1.99000e-04</span><span class="p">,</span> <span class="mf">5.90000e-05</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span>
     <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span>
     <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">,</span> <span class="mf">0.00000e+00</span><span class="p">]</span>
<span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>


<div class="viewcode-block" id="TropOMI">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.TropOMI">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TropOMI</span><span class="p">(</span><span class="n">satellite</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Default TropOMI satellite processor.</span>
<span class="s2">    * bbox subsets the scanline dimensions</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">_defaultkeys</span> <span class="o">=</span> <span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_open_hierarchical_dataset</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isvalid</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to promote PRODUCT GEOLOCATIONS, DETAILED_RESULTS,</span>
<span class="sd">        and INPUT_DATA groups&#39; variables to the main xarray.Dataset object.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to a TropOMI he5-style file</span>
<span class="sd">        bbox : iterable</span>
<span class="sd">            swlon, swlat, nelon, nelat in decimal degrees East and North</span>
<span class="sd">        isvalid : float</span>
<span class="sd">            Pixels are valid with the qa_value is greater than isvalid</span>
<span class="sd">        kwargs : mappable</span>
<span class="sd">            Passed to xarray.open_dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sat: TropOMI</span>
<span class="sd">            Satellite processing instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
        <span class="n">datakey</span> <span class="o">=</span> <span class="s1">&#39;PRODUCT&#39;</span>
        <span class="n">geokey</span> <span class="o">=</span> <span class="s1">&#39;PRODUCT/SUPPORT_DATA/GEOLOCATIONS&#39;</span>
        <span class="n">detkey</span> <span class="o">=</span> <span class="s1">&#39;PRODUCT/SUPPORT_DATA/DETAILED_RESULTS&#39;</span>
        <span class="n">inpkey</span> <span class="o">=</span> <span class="s1">&#39;PRODUCT/SUPPORT_DATA/INPUT_DATA&#39;</span>

        <span class="n">dss</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">datakey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">geokey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">detkey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">inpkey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dss</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prep_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span> <span class="n">isvalid</span><span class="o">=</span><span class="n">isvalid</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="n">sat</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">sat</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">sat</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="n">sat</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="k">return</span> <span class="n">sat</span>

<div class="viewcode-block" id="TropOMI.open_dataset">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.TropOMI.open_dataset">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">open_dataset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isvalid</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to a TropOMI OpenDAP-style file</span>
<span class="sd">        bbox : iterable</span>
<span class="sd">            swlon, swlat, nelon, nelat in decimal degrees East and North</span>
<span class="sd">            of 0, 0</span>
<span class="sd">        isvalid : float</span>
<span class="sd">            Value of qa_value to use for valid pixels</span>
<span class="sd">        kwargs : mappable</span>
<span class="sd">            Passed to xarray.open_dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sat: TropOMI</span>
<span class="sd">            Satellite processing instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;decode_coords&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_open_hierarchical_dataset</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span> <span class="n">isvalid</span><span class="o">=</span><span class="n">isvalid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="n">rename</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;PRODUCT_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;SUPPORT_DATA_DETAILED_RESULTS_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;SUPPORT_DATA_GEOLOCATIONS_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;SUPPORT_DATA_INPUT_DATA_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;METADATA_QA_STATISTICS_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span>
        <span class="p">}</span>
        <span class="n">rename</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;PRODUCT_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">})</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rename</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prep_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span> <span class="n">isvalid</span><span class="o">=</span><span class="n">isvalid</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="n">sat</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">sat</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">sat</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span>
        <span class="n">sat</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="k">return</span> <span class="n">sat</span></div>


<div class="viewcode-block" id="TropOMI.prep_dataset">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.TropOMI.prep_dataset">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">prep_dataset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isvalid</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines pixels as valid when they are within bbox and interpolates</span>
<span class="sd">        latitude and longitude from pixel centers to corners.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Satellite dataset</span>
<span class="sd">        bbox : iterable</span>
<span class="sd">            swlon, swlat, nelon, nelat in decimal degrees East and North</span>
<span class="sd">        isvalid : float</span>
<span class="sd">            When qa_value is greater than isvalid, the pixel is valid.</span>
<span class="sd">        path : str</span>
<span class="sd">            Unused.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="n">hasbnds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;latitude_bounds&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span>
            <span class="ow">and</span> <span class="s1">&#39;longitude_bounds&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">swlon</span><span class="p">,</span> <span class="n">swlat</span><span class="p">,</span> <span class="n">nelon</span><span class="p">,</span> <span class="n">nelat</span> <span class="o">=</span> <span class="n">bbox</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">latitude</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">longitude</span>
            <span class="n">inlon</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon</span> <span class="o">&gt;=</span> <span class="n">swlon</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon</span> <span class="o">&lt;=</span> <span class="n">nelon</span><span class="p">)</span>
            <span class="n">inlat</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat</span> <span class="o">&gt;=</span> <span class="n">swlat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat</span> <span class="o">&lt;=</span> <span class="n">nelat</span><span class="p">)</span>
            <span class="n">inbox</span> <span class="o">=</span> <span class="n">inlon</span> <span class="o">&amp;</span> <span class="n">inlat</span>
            <span class="n">keepline</span> <span class="o">=</span> <span class="n">inbox</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;ground_pixel&#39;</span><span class="p">))</span>
            <span class="c1"># Not subsetting pixel dimension, because I want to use</span>
            <span class="c1"># the cross ways dimension in the interpolation to corners</span>
            <span class="k">if</span> <span class="n">keepline</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1"> has no values in </span><span class="si">{</span><span class="n">bbox</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">hasbnds</span><span class="p">:</span>
                <span class="n">scanslice</span> <span class="o">=</span> <span class="n">keepline</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sval</span> <span class="o">=</span> <span class="n">keepline</span><span class="o">.</span><span class="n">scanline</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">scanline</span><span class="o">=</span><span class="n">keepline</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">scanslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">sval</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sval</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">scanline</span><span class="o">=</span><span class="n">scanslice</span><span class="p">)</span>

        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;cn_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;cn_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">hasbnds</span><span class="p">:</span>
            <span class="n">lat_bnds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">latitude_bounds</span>
            <span class="n">lon_bnds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">longitude_bounds</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;scanline&#39;</span><span class="p">,</span> <span class="s1">&#39;ground_pixel&#39;</span><span class="p">)</span>
            <span class="n">corner_slices</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ll&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ul&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;uu&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;lu&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">cornerkey</span><span class="p">,</span> <span class="n">corner_slice</span> <span class="ow">in</span> <span class="n">corner_slices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ds</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cornerkey</span><span class="si">}</span><span class="s1">_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_bnds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">corner</span><span class="o">=</span><span class="n">corner_slice</span><span class="p">)</span>
                <span class="n">ds</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cornerkey</span><span class="si">}</span><span class="s1">_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon_bnds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">corner</span><span class="o">=</span><span class="n">corner_slice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scanline</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">scanline</span><span class="o">.</span><span class="n">values</span>
            <span class="n">pixel</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ground_pixel</span><span class="o">.</span><span class="n">values</span>
            <span class="n">scanline_edges</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                    <span class="n">scanline</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">scanline</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">scanline</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                <span class="p">]),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;scanline&#39;</span><span class="p">,)</span>
            <span class="p">)</span>
            <span class="n">pixel_edges</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pixel</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">pixel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]]),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ground_pixel&#39;</span><span class="p">,)</span>
            <span class="p">)</span>
            <span class="n">lat_edges</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">scanline</span><span class="o">=</span><span class="n">scanline_edges</span><span class="p">,</span> <span class="n">ground_pixel</span><span class="o">=</span><span class="n">pixel_edges</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">lon_edges</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">scanline</span><span class="o">=</span><span class="n">scanline_edges</span><span class="p">,</span> <span class="n">ground_pixel</span><span class="o">=</span><span class="n">pixel_edges</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;scanline&#39;</span><span class="p">,</span> <span class="s1">&#39;ground_pixel&#39;</span><span class="p">)</span>
            <span class="n">corner_slices</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ll&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="s1">&#39;lu&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
                <span class="s1">&#39;uu&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
                <span class="s1">&#39;ul&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                <span class="s1">&#39;scanline&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;scanline&#39;</span><span class="p">],</span>
                <span class="s1">&#39;ground_pixel&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;ground_pixel&#39;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">cornerkey</span><span class="p">,</span> <span class="n">corner_slice</span> <span class="ow">in</span> <span class="n">corner_slices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ds</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cornerkey</span><span class="si">}</span><span class="s1">_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">lat_edges</span><span class="p">[</span><span class="n">corner_slice</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span>
                <span class="p">)</span>
                <span class="n">ds</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cornerkey</span><span class="si">}</span><span class="s1">_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">lon_edges</span><span class="p">[</span><span class="n">corner_slice</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span>
                <span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;qa_value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">isvalid</span>
        <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">swlat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nelat</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">swlon</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nelon</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># The HCHO OpenDAP file constants have dimensions (&#39;time&#39;, &#39;layer&#39;)</span>
        <span class="k">for</span> <span class="n">vkey</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tm5_constant_a&#39;</span><span class="p">,</span> <span class="s1">&#39;tm5_constant_b&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">vkey</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">vvar</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">vkey</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">vvar</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="n">ds</span><span class="p">[</span><span class="n">vkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">vvar</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid pixels&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="TropOMI.shorten_name">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.TropOMI.shorten_name">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shorten_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provide a short name for long keys. This is useful for renaming</span>
<span class="sd">        variables to fit IOAPI 16 character restrictions.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        key : str</span>
<span class="sd">            Original variable name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        shortkey : str</span>
<span class="sd">            Shortened key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SUPPORT_DATA_DETAILED_RESULTS&#39;</span><span class="p">,</span> <span class="s1">&#39;SUP&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SUPPORT_DATA_INPUT_DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;IN&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;SUPPORT_DATA_GEOLOCATIONS&#39;</span><span class="p">,</span> <span class="s1">&#39;GEO&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;TOT&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;tropospheric&#39;</span><span class="p">,</span> <span class="s1">&#39;TROP&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;stratospheric&#39;</span><span class="p">,</span> <span class="s1">&#39;STRAT&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="s1">&#39;VCD&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;averaging_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;AK&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;carbonmonoxide&#39;</span><span class="p">,</span> <span class="s1">&#39;CO&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;nitrogendioxide&#39;</span><span class="p">,</span> <span class="s1">&#39;NO2&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;surface&#39;</span><span class="p">,</span> <span class="s1">&#39;sfc&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;pres&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span></div>


<div class="viewcode-block" id="TropOMI.cmaq_sw">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.TropOMI.cmaq_sw">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_sw</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="p">,</span> <span class="n">tropopausekey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate scattering weights as averaging kernel multiplied by the</span>
<span class="sd">        total air mass factor. Then, interpolate to CMAQ vertical grid, based</span>
<span class="sd">        on PRES (pressure in Pa). The scattering weights are set to 0 above</span>
<span class="sd">        the tropopause.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        overf : xarray.Dataset</span>
<span class="sd">            Must have PRES variable with LAY dimension that describes the</span>
<span class="sd">            vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>
<span class="sd">        amfkey : str</span>
<span class="sd">            Key for the total air mass factor.</span>
<span class="sd">        tropopauskey : str</span>
<span class="sd">            Key for the tropopause when available. Otherwise, use None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        q_sw_trop : xr.DataArray</span>
<span class="sd">            Tropospheric scattering Weights on the CMAQ grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">...utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">coord_interp</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>

        <span class="k">if</span> <span class="s1">&#39;tm5_constant_b&#39;</span> <span class="ow">in</span> <span class="n">satl3f</span><span class="p">:</span>
            <span class="n">tm5_b</span> <span class="o">=</span> <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;tm5_constant_b&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;vertices&#39;</span> <span class="ow">in</span> <span class="n">tm5_b</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">tm5_b</span> <span class="o">=</span> <span class="n">tm5_b</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;vertices&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tm5_b</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">tm5_constant_b</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">,),</span>
                <span class="n">coords</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;tm5_constant_a&#39;</span> <span class="ow">in</span> <span class="n">satl3f</span><span class="p">:</span>
            <span class="n">tm5_a</span> <span class="o">=</span> <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;tm5_constant_a&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;vertices&#39;</span> <span class="ow">in</span> <span class="n">tm5_a</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">tm5_a</span> <span class="o">=</span> <span class="n">tm5_a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;vertices&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tm5_a</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">tm5_constant_a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">,),</span>
                <span class="n">coords</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="n">pres</span> <span class="o">=</span> <span class="n">tm5_b</span> <span class="o">*</span> <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;surface_pressure&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tm5_a</span>
        <span class="n">akkey</span> <span class="o">=</span> <span class="s1">&#39;averaging_kernel&#39;</span>
        <span class="n">ak</span> <span class="o">=</span> <span class="n">satl3f</span><span class="p">[</span><span class="n">akkey</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tropopausekey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ak</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">satl3f</span><span class="p">[</span><span class="n">tropopausekey</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">])</span>

        <span class="n">sw_trop</span> <span class="o">=</span> <span class="n">ak</span> <span class="o">*</span> <span class="n">satl3f</span><span class="p">[</span><span class="n">amfkey</span><span class="p">]</span>

        <span class="n">q_sw_trop</span> <span class="o">=</span> <span class="n">coord_interp</span><span class="p">(</span>
            <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;PRES&#39;</span><span class="p">],</span> <span class="n">pres</span><span class="p">,</span> <span class="n">sw_trop</span><span class="p">,</span>
            <span class="n">indim</span><span class="o">=</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="n">outdim</span><span class="o">=</span><span class="s1">&#39;LAY&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">q_sw_trop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">satl3f</span><span class="p">[</span><span class="n">akkey</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">q_sw_trop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s1">&#39;SW&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">var_desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">akkey</span><span class="si">}</span><span class="s1"> * </span><span class="si">{</span><span class="n">amfkey</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)[:</span><span class="mi">80</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">q_sw_trop</span></div>


<div class="viewcode-block" id="TropOMI.cmaq_amf">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.TropOMI.cmaq_amf">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_amf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate an alternative Air Mass Factor (AMF) using satellite</span>
<span class="sd">        scattering weights and the CMAQ vertical profile as a partial column</span>
<span class="sd">        density.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        overf : xarray.Dataset</span>
<span class="sd">            Must have PRES variable with LAY dimension that describes the</span>
<span class="sd">            vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>
<span class="sd">        amfkey : str</span>
<span class="sd">            Key of the total air mass factor</span>
<span class="sd">        key : str</span>
<span class="sd">            Key of the partial column density variable from CMAQ, which must</span>
<span class="sd">            have a LAY dimension that describes teh vertical coordinate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cmaqamf : xr.DataArray</span>
<span class="sd">            Air Mass Factor on the CMAQ grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q_sw_trop</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmaq_sw</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="n">amfkey</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">overf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;LAY&#39;</span><span class="p">)</span>
        <span class="n">q_amf</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_sw_trop</span> <span class="o">*</span> <span class="n">overf</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;LAY&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span>
        <span class="n">q_amf</span> <span class="o">=</span> <span class="n">q_amf</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">denom</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">q_sw_trop</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;LAY&#39;</span><span class="p">))</span>
        <span class="n">q_amf</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">q_sw_trop</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">vdesc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(SW * </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">).sum() / </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">.sum()&#39;</span>
        <span class="n">q_amf</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s1">&#39;AMF&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">var_desc</span><span class="o">=</span><span class="n">vdesc</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)[:</span><span class="mi">80</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">q_amf</span></div>
</div>



<div class="viewcode-block" id="S5P_L2__CO____">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__CO____">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">S5P_L2__CO____</span><span class="p">(</span><span class="n">TropOMI</span><span class="p">):</span>
    <span class="n">_defaultkeys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;carbonmonoxide_total_column&#39;</span><span class="p">,</span> <span class="s1">&#39;column_averaging_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span>
    <span class="p">)</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    TropOMICO satellite processor.</span>
<span class="s2">    * bbox subsets the scanline dimensions</span>
<span class="s2">    * valid = qa_value &gt;= threshold (default 0.75)</span>
<span class="s2">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="S5P_L2__CO____.cmr_links">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__CO____.cmr_links">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmr_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;opendap&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Thin wrapper around satellite.cmr_links where concept_id is set to</span>
<span class="sd">        &quot;C2087132178-GES_DISC&quot;, which is the HiR product v2. The HiR v2</span>
<span class="sd">        product starts 2018-04-30.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        method : str</span>
<span class="sd">            &#39;opendap&#39;, &#39;download&#39;, or &#39;s3&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        links : list</span>
<span class="sd">            List of links for download or OpenDAP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;concept_id&#39;</span><span class="p">,</span> <span class="s1">&#39;C2087132178-GES_DISC&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TropOMI</span><span class="o">.</span><span class="n">cmr_links</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="S5P_L2__CO____.cmaq_process">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__CO____.cmaq_process">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_process</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">qf</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;CO&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process CMAQ as though it were observed by TropOMI, which is simply</span>
<span class="sd">        based on the overpass time.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        qf : xarray.Dataset</span>
<span class="sd">            CMAQ file that has composition (e.g., CO)</span>
<span class="sd">        l3 : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        overf : xr.DataArray</span>
<span class="sd">            An overpass file with satellite-like CMAQ.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>

        <span class="n">skey</span> <span class="o">=</span> <span class="s1">&#39;carbonmonoxide_total_column&#39;</span>
        <span class="n">overf</span> <span class="o">=</span> <span class="n">qf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">mean_overpass</span><span class="p">(</span><span class="n">satellite</span><span class="o">=</span><span class="s1">&#39;aura&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="o">~</span><span class="n">l3</span><span class="p">[</span><span class="n">skey</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">n_per_m2</span> <span class="o">=</span> <span class="n">overf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">mole_per_m2</span><span class="p">(</span><span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tgtvar</span> <span class="o">=</span> <span class="n">overf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tgtvar</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ppm&#39;</span><span class="p">):</span>
            <span class="n">vmr</span> <span class="o">=</span> <span class="n">tgtvar</span> <span class="o">/</span> <span class="mf">1e6</span>
        <span class="k">elif</span> <span class="n">tgtvar</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ppb&#39;</span><span class="p">):</span>
            <span class="n">vmr</span> <span class="o">=</span> <span class="n">tgtvar</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="k">elif</span> <span class="n">tgtvar</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ppt&#39;</span><span class="p">):</span>
            <span class="n">vmr</span> <span class="o">=</span> <span class="n">tgtvar</span> <span class="o">/</span> <span class="mf">1e12</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;CO_MOL_PER_M2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_per_m2</span> <span class="o">*</span> <span class="n">vmr</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;CO_MOL_PER_M2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;CO_MOL_PER_M2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mole/m**2&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDCO_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;CO_MOL_PER_M2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;LAY&#39;</span><span class="p">)</span>

        <span class="c1"># For CO, the model should be integrated to meter-based vertical levels</span>
        <span class="c1"># https://sentinels.copernicus.eu/documents/247904/3541451/Sentinel-5P-</span>
        <span class="c1"># Carbon-Monoxide-Level-2-Product-Readme-File.pdf/f8942626-ffb6-4951-90</span>
        <span class="c1"># fc-a16b6589e39e?t=1658386616101</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">l3</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">tops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l3</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dz</span><span class="p">)</span>
        <span class="n">akvar</span> <span class="o">=</span> <span class="n">l3</span><span class="p">[</span><span class="s1">&#39;column_averaging_kernel&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">akvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="c1"># Older than v2.0.4 uses needs to be divided by 1000m</span>
            <span class="c1"># which is the depth of each layer.</span>
            <span class="n">ak</span> <span class="o">=</span> <span class="n">akvar</span><span class="p">[:]</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ak</span> <span class="o">=</span> <span class="n">akvar</span><span class="p">[:]</span>

        <span class="n">nl</span> <span class="o">=</span> <span class="n">l3</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span>
        <span class="n">CO_MOL_PER_M2_Z</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nl</span><span class="p">,</span> <span class="n">overf</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;ROW&#39;</span><span class="p">],</span> <span class="n">overf</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;COL&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">),</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="s1">&#39;ROW&#39;</span><span class="p">,</span> <span class="s1">&#39;COL&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CO_MOL_PER_M2_Z&#39;</span>
        <span class="p">)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDCO_CMAQ_TOMI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">overf</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;ROW&#39;</span><span class="p">],</span> <span class="n">overf</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;COL&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">),</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ROW&#39;</span><span class="p">,</span> <span class="s1">&#39;COL&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;VCDCO_CMAQ_TOMI&#39;</span>
        <span class="p">)</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">)</span>
        <span class="c1"># Currently looping over rows, which is inefficient.</span>
        <span class="k">for</span> <span class="n">ri</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">overf</span><span class="p">[</span><span class="s1">&#39;ROW&#39;</span><span class="p">]):</span>
            <span class="c1"># print(&#39;.&#39;, end=&#39;&#39;, flush=True)</span>
            <span class="k">if</span> <span class="n">skip</span><span class="p">[</span><span class="n">ri</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">ci</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">overf</span><span class="p">[</span><span class="s1">&#39;COL&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">skip</span><span class="p">[</span><span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">cdfp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">overf</span><span class="p">[</span><span class="s1">&#39;CO_MOL_PER_M2&#39;</span><span class="p">][:,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">zfp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;ZF&#39;</span><span class="p">][:,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">])</span>
                <span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">tops</span><span class="p">,</span> <span class="n">zfp</span><span class="p">,</span> <span class="n">cdfp</span><span class="p">)</span>
                <span class="n">pmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cdf</span><span class="p">)</span>
                <span class="n">CO_MOL_PER_M2_Z</span><span class="p">[:,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmf</span>
                <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDCO_CMAQ_TOMI&#39;</span><span class="p">][</span><span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">CO_MOL_PER_M2_Z</span><span class="p">[:,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">]</span> <span class="o">*</span> <span class="n">ak</span><span class="p">[</span><span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># overf[&#39;CO_MOL_PER_M2_Z&#39;] = CO_MOL_PER_M2_Z.where(~skip)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDCO_CMAQ_TOMI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDCO_CMAQ_TOMI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">skip</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">overf</span></div>
</div>



<div class="viewcode-block" id="S5P_L2__NO2___">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__NO2___">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">S5P_L2__NO2___</span><span class="p">(</span><span class="n">TropOMI</span><span class="p">):</span>
    <span class="n">_defaultkeys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;air_mass_factor_total&#39;</span><span class="p">,</span> <span class="s1">&#39;air_mass_factor_troposphere&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nitrogendioxide_tropospheric_column&#39;</span><span class="p">,</span> <span class="s1">&#39;nitrogendioxide_total_column&#39;</span><span class="p">,</span>
        <span class="s1">&#39;averaging_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;tm5_tropopause_layer_index&#39;</span><span class="p">,</span> <span class="s1">&#39;surface_pressure&#39;</span>
    <span class="p">)</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    TropOMINO2 satellite processor.</span>
<span class="s2">    * bbox subsets the scanline dimensions</span>
<span class="s2">    * valid = qa_value &gt;= threshold (default 0.75)</span>
<span class="s2">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="S5P_L2__NO2___.cmr_links">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__NO2___.cmr_links">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmr_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;opendap&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Thin wrapper around satellite.cmr_links where concept_id is set to</span>
<span class="sd">        &quot;C2089270961-GES_DISC&quot;, which is the HiR v2 product. The HiR v2</span>
<span class="sd">        product starts 2018-05-01.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        method : str</span>
<span class="sd">            &#39;opendap&#39;, &#39;download&#39;, or &#39;s3&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        links : list</span>
<span class="sd">            List of links for download or OpenDAP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;concept_id&#39;</span><span class="p">,</span> <span class="s1">&#39;C2089270961-GES_DISC&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TropOMI</span><span class="o">.</span><span class="n">cmr_links</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="S5P_L2__NO2___.cmaq_sw">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__NO2___.cmaq_sw">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_sw</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="s1">&#39;air_mass_factor_total&#39;</span><span class="p">,</span>
        <span class="n">tropopausekey</span><span class="o">=</span><span class="s1">&#39;tm5_tropopause_layer_index&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate scattering weights as averaging kernel multiplied by the</span>
<span class="sd">        total air mass factor. Then, interpolate to CMAQ vertical grid, based</span>
<span class="sd">        on PRES (pressure in Pa). The scattering weights are set to 0 above</span>
<span class="sd">        the tropopause.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        overf : xarray.Dataset</span>
<span class="sd">            Must have PRES variable with LAY dimension that describes the</span>
<span class="sd">            vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>
<span class="sd">        amfkey : str</span>
<span class="sd">            Key for the total air mass factor.</span>
<span class="sd">        tropopausekey : str</span>
<span class="sd">            Key for the tropopause index.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        q_sw_trop : xr.DataArray</span>
<span class="sd">            Tropospheric scattering Weights on the CMAQ grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TropOMI</span><span class="o">.</span><span class="n">cmaq_sw</span><span class="p">(</span>
            <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="n">amfkey</span><span class="p">,</span> <span class="n">tropopausekey</span><span class="o">=</span><span class="n">tropopausekey</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="S5P_L2__NO2___.cmaq_amf">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__NO2___.cmaq_amf">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_amf</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="s1">&#39;air_mass_factor_total&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;NO2_PER_M2&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate an alternative Air Mass Factor (AMF) using satellite</span>
<span class="sd">        scattering weights and the CMAQ vertical profile as a partial column</span>
<span class="sd">        density.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        overf : xarray.Dataset</span>
<span class="sd">            Must have PRES variable with LAY dimension that describes the</span>
<span class="sd">            vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>
<span class="sd">        amfkey : str</span>
<span class="sd">            Key of the total air mass factor</span>
<span class="sd">        key : str</span>
<span class="sd">            Key of the partial column density variable from CMAQ, which must</span>
<span class="sd">            have a LAY dimension that describes teh vertical coordinate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cmaqamf : xr.DataArray</span>
<span class="sd">            Air Mass Factor on the CMAQ grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TropOMI</span><span class="o">.</span><span class="n">cmaq_amf</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="n">amfkey</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="S5P_L2__NO2___.cmaq_ak">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__NO2___.cmaq_ak">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_ak</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="s1">&#39;air_mass_factor_total&#39;</span><span class="p">,</span>
        <span class="n">amftropkey</span><span class="o">=</span><span class="s1">&#39;air_mass_factor_troposphere&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate an averaging kernel (AK) that would process CMAQ as though</span>
<span class="sd">        it were observed by the satellite. In this case, the averaging kernel</span>
<span class="sd">        is the scattering weights divided by the tropospheric air mass factor.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        overf : xarray.Dataset</span>
<span class="sd">            Must have PRES variable with LAY dimension that describes the</span>
<span class="sd">            vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>
<span class="sd">        amfkey : str</span>
<span class="sd">            amfkey should points to the total column amf, which is used to</span>
<span class="sd">            convert the averaging kernel to scattering weights. The scattering</span>
<span class="sd">            weights</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        q_ak : xr.DataArray</span>
<span class="sd">            Averaging kernel on the CMAQ grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q_sw_trop</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmaq_sw</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="n">amfkey</span><span class="p">)</span>
        <span class="n">q_ak</span> <span class="o">=</span> <span class="n">q_sw_trop</span> <span class="o">/</span> <span class="n">satl3f</span><span class="p">[</span><span class="n">amftropkey</span><span class="p">]</span>
        <span class="n">q_ak</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">q_sw_trop</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">vdesc</span> <span class="o">=</span> <span class="n">q_sw_trop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;var_desc&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;AK * </span><span class="si">{</span><span class="n">amfkey</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">vdesc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; / </span><span class="si">{</span><span class="n">amftropkey</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">q_ak</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">var_desc</span><span class="o">=</span><span class="n">vdesc</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)[:</span><span class="mi">80</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">q_ak</span></div>


<div class="viewcode-block" id="S5P_L2__NO2___.cmaq_process">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__NO2___.cmaq_process">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_process</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">qf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;NO2&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process CMAQ as though it were observed by TropOMI and recalculate</span>
<span class="sd">        TropOMI tropospheric columns with the CMAQ AMF. This process relies</span>
<span class="sd">        on cmaq_ak and cmaq_amf.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        qf : xarray.Dataset</span>
<span class="sd">            CMAQ file that has composition (e.g., NO2), PRES, DENS, and ZF</span>
<span class="sd">            variables with a LAY dimension describing the vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>
<span class="sd">        key : str</span>
<span class="sd">            Composition key</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        overf : xr.DataArray</span>
<span class="sd">            An overpass file with satellite-like CMAQ and CMAQ-like satellite.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># OMI is on the aura satellite, so we create an average overpass</span>
        <span class="n">overf</span> <span class="o">=</span> <span class="n">qf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">mean_overpass</span><span class="p">(</span><span class="n">satellite</span><span class="o">=</span><span class="s1">&#39;aura&#39;</span><span class="p">)</span>
        <span class="n">n_per_m2</span> <span class="o">=</span> <span class="n">overf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">mole_per_m2</span><span class="p">(</span><span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tgtvar</span> <span class="o">=</span> <span class="n">overf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tgtvar</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ppm&#39;</span><span class="p">):</span>
            <span class="n">vmr</span> <span class="o">=</span> <span class="n">tgtvar</span> <span class="o">/</span> <span class="mf">1e6</span>
        <span class="k">elif</span> <span class="n">tgtvar</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ppb&#39;</span><span class="p">):</span>
            <span class="n">vmr</span> <span class="o">=</span> <span class="n">tgtvar</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="k">elif</span> <span class="n">tgtvar</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ppt&#39;</span><span class="p">):</span>
            <span class="n">vmr</span> <span class="o">=</span> <span class="n">tgtvar</span> <span class="o">/</span> <span class="mf">1e12</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;NO2_PER_M2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_per_m2</span> <span class="o">*</span> <span class="n">vmr</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;NO2_PER_M2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;NO2_PER_M2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">units</span><span class="o">=</span><span class="s1">&#39;mole/m**2&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">var_desc</span><span class="o">=</span><span class="s1">&#39;NO2 areal density&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">ak</span> <span class="o">=</span> <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;NO2_AK_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmaq_ak</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">)</span>
        <span class="n">ak</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">var_desc</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="p">)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;NO2_SW_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmaq_sw</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">)</span>
        <span class="c1"># Calculate CMAQ vertical column density twice:</span>
        <span class="c1"># 1. uses AK for identifying tropopause; other wise sum</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDNO2_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">apply_ak</span><span class="p">(</span><span class="s1">&#39;NO2_PER_M2&#39;</span><span class="p">,</span> <span class="n">ak</span> <span class="o">/</span> <span class="n">ak</span><span class="p">)</span>
        <span class="n">vdesc</span> <span class="o">=</span> <span class="s1">&#39;NO2_PER_M2 simple sum within troposphere&#39;</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDNO2_CMAQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">var_desc</span><span class="o">=</span><span class="n">vdesc</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)[:</span><span class="mi">80</span><span class="p">])</span>

        <span class="c1"># 2. use AK for vertical weighting</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDNO2_CMAQ_TOMI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">apply_ak</span><span class="p">(</span><span class="s1">&#39;NO2_PER_M2&#39;</span><span class="p">,</span> <span class="n">ak</span><span class="p">)</span>
        <span class="n">vdesc</span> <span class="o">=</span> <span class="s1">&#39;NO2_PER_M2 integrated with TropOMI averaging kernel&#39;</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDNO2_CMAQ_TOMI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">var_desc</span><span class="o">=</span><span class="n">vdesc</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)[:</span><span class="mi">80</span><span class="p">])</span>

        <span class="c1"># Calculate AMF using CMAQ prior and satellite scattering weights</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;AMF_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmaq_amf</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;NO2_PER_M2&#39;</span><span class="p">)</span>
        <span class="n">vdesc</span> <span class="o">=</span> <span class="s1">&#39;tropospheric air mass factor using CMAQ prior&#39;</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;AMF_CMAQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">var_desc</span><span class="o">=</span><span class="n">vdesc</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)[:</span><span class="mi">80</span><span class="p">])</span>

        <span class="c1"># Recalculate satellite VCD using CMAQ&#39;s AMF</span>
        <span class="n">vcdtomi</span> <span class="o">=</span> <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;nitrogendioxide_tropospheric_column&#39;</span><span class="p">]</span>
        <span class="n">amftomi</span> <span class="o">=</span> <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;air_mass_factor_troposphere&#39;</span><span class="p">]</span>
        <span class="n">vcdtomiq</span> <span class="o">=</span> <span class="n">vcdtomi</span> <span class="o">*</span> <span class="n">amftomi</span> <span class="o">/</span> <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;AMF_CMAQ&#39;</span><span class="p">]</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vcdtomi</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;var_desc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TropOMI_NO2 x TropOMI_AMF / CMAQ_AMF&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDNO2_TOMI_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcdtomiq</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">vcdtomiq</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">attrs</span>

        <span class="k">return</span> <span class="n">overf</span></div>
</div>



<div class="viewcode-block" id="S5P_L2__CH4___">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__CH4___">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">S5P_L2__CH4___</span><span class="p">(</span><span class="n">TropOMI</span><span class="p">):</span>
    <span class="n">_defaultkeys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;methane_mixing_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;methane_mixing_ratio_bias_corrected&#39;</span><span class="p">,</span>
        <span class="s1">&#39;averaging_kernel&#39;</span>
    <span class="p">)</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    TropOMICH4 satellite processor.</span>
<span class="s2">    * bbox subsets the scanline dimensions</span>
<span class="s2">    * valid = qa_value &gt;= threshold (default 0.75)</span>
<span class="s2">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="S5P_L2__CH4___.cmr_links">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__CH4___.cmr_links">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmr_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;opendap&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Thin wrapper around satellite.cmr_links where concept_id is set to</span>
<span class="sd">        &quot;C2087216530-GES_DISC&quot;, which is the HiR v2 product. The HiR product</span>
<span class="sd">        started 2018-04-30.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        method : str</span>
<span class="sd">            &#39;opendap&#39;, &#39;download&#39;, or &#39;s3&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        links : list</span>
<span class="sd">            List of links for download or OpenDAP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;concept_id&#39;</span><span class="p">,</span> <span class="s1">&#39;C2087216530-GES_DISC&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TropOMI</span><span class="o">.</span><span class="n">cmr_links</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="S5P_L2__CH4___.cmaq_process">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__CH4___.cmaq_process">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_process</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">qf</span><span class="p">,</span> <span class="n">l3</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;CH4&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process CMAQ as though it were observed by TropOMI, which is simply</span>
<span class="sd">        based on the overpass time.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        qf : xarray.Dataset</span>
<span class="sd">            CMAQ file that has composition (e.g., ECH4)</span>
<span class="sd">        l3 : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        overf : xr.DataArray</span>
<span class="sd">            An overpass file with satellite-like CMAQ.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skey</span> <span class="o">=</span> <span class="s1">&#39;methane_mixing_ratio&#39;</span>
        <span class="n">overf</span> <span class="o">=</span> <span class="n">qf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">mean_overpass</span><span class="p">(</span><span class="n">satellite</span><span class="o">=</span><span class="s1">&#39;aura&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="o">~</span><span class="n">l3</span><span class="p">[</span><span class="n">skey</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">overf</span></div>
</div>



<div class="viewcode-block" id="S5P_L2__HCHO__">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__HCHO__">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">S5P_L2__HCHO__</span><span class="p">(</span><span class="n">TropOMI</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    TropOMIHCHO satellite processor.</span>
<span class="s2">    * bbox subsets the scanline dimensions</span>
<span class="s2">    * valid = qa_value &gt;= threshold (default 0.75)</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">_defaultkeys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;formaldehyde_profile_apriori&#39;</span><span class="p">,</span> <span class="s1">&#39;averaging_kernel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;formaldehyde_tropospheric_air_mass_factor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;formaldehyde_tropospheric_vertical_column&#39;</span><span class="p">,</span>
        <span class="s1">&#39;surface_pressure&#39;</span>
    <span class="p">)</span>

<div class="viewcode-block" id="S5P_L2__HCHO__.cmr_links">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__HCHO__.cmr_links">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmr_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;opendap&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Thin wrapper around satellite.cmr_links where concept_id is set to</span>
<span class="sd">        &quot;C1918210023-GES_DISC&quot;, which is the HiR v2 product. The HiR v2 product</span>
<span class="sd">        starts in 2018-05-07.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        method : str</span>
<span class="sd">            &#39;opendap&#39;, &#39;download&#39;, or &#39;s3&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        links : list</span>
<span class="sd">            List of links for download or OpenDAP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;concept_id&#39;</span><span class="p">,</span> <span class="s1">&#39;C1918210023-GES_DISC&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TropOMI</span><span class="o">.</span><span class="n">cmr_links</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="S5P_L2__HCHO__.cmaq_sw">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__HCHO__.cmaq_sw">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_sw</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="s1">&#39;formaldehyde_tropospheric_air_mass_factor&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate scattering weights as averaging kernel multiplied by the</span>
<span class="sd">        total air mass factor. Then, interpolate to CMAQ vertical grid, based</span>
<span class="sd">        on PRES (pressure in Pa). The scattering weights are set to 0 above</span>
<span class="sd">        the tropopause.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        overf : xarray.Dataset</span>
<span class="sd">            Must have PRES variable with LAY dimension that describes the</span>
<span class="sd">            vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>
<span class="sd">        amfkey : str</span>
<span class="sd">            Key for the total air mass factor.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        q_sw_trop : xr.DataArray</span>
<span class="sd">            Tropospheric scattering Weights on the CMAQ grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TropOMI</span><span class="o">.</span><span class="n">cmaq_sw</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="n">amfkey</span><span class="p">)</span></div>


<div class="viewcode-block" id="S5P_L2__HCHO__.cmaq_amf">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__HCHO__.cmaq_amf">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_amf</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span>
        <span class="n">amfkey</span><span class="o">=</span><span class="s1">&#39;formaldehyde_tropospheric_air_mass_factor&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;FORM_PER_M2&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate an alternative Air Mass Factor (AMF) using satellite</span>
<span class="sd">        scattering weights and the CMAQ vertical profile as a partial column</span>
<span class="sd">        density.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        overf : xarray.Dataset</span>
<span class="sd">            Must have PRES variable with LAY dimension that describes the</span>
<span class="sd">            vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>
<span class="sd">        amfkey : str</span>
<span class="sd">            Key of the total air mass factor</span>
<span class="sd">        key : str</span>
<span class="sd">            Key of the partial column density variable from CMAQ, which must</span>
<span class="sd">            have a LAY dimension that describes teh vertical coordinate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cmaqamf : xr.DataArray</span>
<span class="sd">            Air Mass Factor on the CMAQ grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TropOMI</span><span class="o">.</span><span class="n">cmaq_amf</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">amfkey</span><span class="o">=</span><span class="n">amfkey</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="S5P_L2__HCHO__.cmaq_ak">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__HCHO__.cmaq_ak">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_ak</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate an averaging kernel (AK) that would process CMAQ as though</span>
<span class="sd">        it were observed by the satellite. In this case, the averaging kernel</span>
<span class="sd">        is the scattering weights divided by the tropospheric air mass factor.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        overf : xarray.Dataset</span>
<span class="sd">            Must have PRES variable with LAY dimension that describes the</span>
<span class="sd">            vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        q_ak : xr.DataArray</span>
<span class="sd">            Averaging kernel on the CMAQ grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q_sw_trop</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmaq_sw</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">)</span>
        <span class="n">q_ak</span> <span class="o">=</span> <span class="n">q_sw_trop</span> <span class="o">/</span> <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;formaldehyde_tropospheric_air_mass_factor&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">q_ak</span></div>


<div class="viewcode-block" id="S5P_L2__HCHO__.cmaq_process">
<a class="viewcode-back" href="../../../api/cmaqsatproc.readers.tropomi.html#cmaqsatproc.readers.tropomi.S5P_L2__HCHO__.cmaq_process">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cmaq_process</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">qf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;FORM&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process CMAQ as though it were observed by OMI and recalculate TropOMI</span>
<span class="sd">        tropospheric columns with the CMAQ AMF. This process relies on cmaq_ak</span>
<span class="sd">        and cmaq_amf.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        qf : xarray.Dataset</span>
<span class="sd">            CMAQ file that has composition (e.g., FORM), PRES, DENS, and ZF</span>
<span class="sd">            variables with a LAY dimension describing the vertical coordinate.</span>

<span class="sd">        satl3f : xarray.Dataset</span>
<span class="sd">            Output from to_level3, paths_to_level3, or cmr_to_level3 with</span>
<span class="sd">            as_dataset=True (the default).</span>
<span class="sd">        key : str</span>
<span class="sd">            Composition key</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        overf : xr.DataArray</span>
<span class="sd">            An overpass file with satellite-like CMAQ and CMAQ-like satellite.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># OMI is on the aura satellite, so we create an average overpass</span>
        <span class="n">overf</span> <span class="o">=</span> <span class="n">qf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">mean_overpass</span><span class="p">(</span><span class="n">satellite</span><span class="o">=</span><span class="s1">&#39;aura&#39;</span><span class="p">)</span>
        <span class="n">n_per_m2</span> <span class="o">=</span> <span class="n">overf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">mole_per_m2</span><span class="p">(</span><span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tgtvar</span> <span class="o">=</span> <span class="n">overf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tgtvar</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ppm&#39;</span><span class="p">):</span>
            <span class="n">vmr</span> <span class="o">=</span> <span class="n">tgtvar</span> <span class="o">/</span> <span class="mf">1e6</span>
        <span class="k">elif</span> <span class="n">tgtvar</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ppb&#39;</span><span class="p">):</span>
            <span class="n">vmr</span> <span class="o">=</span> <span class="n">tgtvar</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="k">elif</span> <span class="n">tgtvar</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ppt&#39;</span><span class="p">):</span>
            <span class="n">vmr</span> <span class="o">=</span> <span class="n">tgtvar</span> <span class="o">/</span> <span class="mf">1e12</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;FORM_PER_M2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_per_m2</span> <span class="o">*</span> <span class="n">vmr</span>

        <span class="n">ak</span> <span class="o">=</span> <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;FORM_AK_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmaq_ak</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;FORM_SW_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmaq_sw</span><span class="p">(</span><span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">)</span>
        <span class="c1"># uses AK for tropopause</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDFORM_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">apply_ak</span><span class="p">(</span><span class="s1">&#39;FORM_PER_M2&#39;</span><span class="p">,</span> <span class="n">ak</span> <span class="o">/</span> <span class="n">ak</span><span class="p">)</span>
        <span class="c1"># uses AK for vertical weighting</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDFORM_CMAQ_TOMI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overf</span><span class="o">.</span><span class="n">csp</span><span class="o">.</span><span class="n">apply_ak</span><span class="p">(</span><span class="s1">&#39;FORM_PER_M2&#39;</span><span class="p">,</span> <span class="n">ak</span><span class="p">)</span>
        <span class="c1"># Recalculate satellite</span>
        <span class="n">amf</span> <span class="o">=</span> <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;AMF_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmaq_amf</span><span class="p">(</span>
            <span class="n">overf</span><span class="p">,</span> <span class="n">satl3f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;FORM_PER_M2&#39;</span>
        <span class="p">)</span>

        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDHCHO_TOMI_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;formaldehyde_tropospheric_vertical_column&#39;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;formaldehyde_tropospheric_air_mass_factor&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">amf</span>
        <span class="p">)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDHCHO_TOMI_CMAQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">satl3f</span><span class="p">[</span><span class="s1">&#39;formaldehyde_tropospheric_vertical_column&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="p">)</span>
        <span class="n">overf</span><span class="p">[</span><span class="s1">&#39;VCDHCHO_TOMI_CMAQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;var_desc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;TropOMI_NO2 x TropOMI_AMF / CMAQ_AMF&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">overf</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">cmaqsatproc</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Users Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Example Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cmaqsatproc.html">cmaqsatproc package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../readers.html">cmaqsatproc.readers</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023, Barron H. Henderson.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 9.1.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>