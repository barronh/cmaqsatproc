<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cmaqsatproc.utils &#8212; cmaqsatproc &#39;0.5.2&#39;
 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <script src="../../_static/documentation_options.js?v=6a8ba589"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cmaqsatproc.utils</h1><div class="highlight"><pre>
<span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;getcmrlinks&#39;</span><span class="p">,</span> <span class="s1">&#39;getcmrgranules&#39;</span><span class="p">,</span> <span class="s1">&#39;rootremover&#39;</span><span class="p">,</span> <span class="s1">&#39;grouped_weighted_avg&#39;</span><span class="p">,</span>
    <span class="s1">&#39;walk_groups&#39;</span><span class="p">,</span> <span class="s1">&#39;EasyDataFramePoint&#39;</span><span class="p">,</span> <span class="s1">&#39;EasyDataFramePolygon&#39;</span><span class="p">,</span> <span class="s1">&#39;cdconvert&#39;</span><span class="p">,</span>
    <span class="s1">&#39;csp_version&#39;</span>
<span class="p">]</span>


<span class="n">_ckeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ll&#39;</span><span class="p">,</span> <span class="s1">&#39;lu&#39;</span><span class="p">,</span> <span class="s1">&#39;uu&#39;</span><span class="p">,</span> <span class="s1">&#39;ul&#39;</span><span class="p">]</span>
<span class="n">_xcrnrkeys</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ckey</span><span class="si">}</span><span class="s1">_x&#39;</span> <span class="k">for</span> <span class="n">ckey</span> <span class="ow">in</span> <span class="n">_ckeys</span><span class="p">]</span>
<span class="n">_ycrnrkeys</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ckey</span><span class="si">}</span><span class="s1">_y&#39;</span> <span class="k">for</span> <span class="n">ckey</span> <span class="ow">in</span> <span class="n">_ckeys</span><span class="p">]</span>


<div class="viewcode-block" id="csp_version">
<a class="viewcode-back" href="../../api/cmaqsatproc.utils.html#cmaqsatproc.utils.csp_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">csp_version</span><span class="p">():</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">_csp_version</span>
    <span class="k">return</span> <span class="n">_csp_version</span></div>



<div class="viewcode-block" id="walk_groups">
<a class="viewcode-back" href="../../api/cmaqsatproc.utils.html#cmaqsatproc.utils.walk_groups">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">walk_groups</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">gkey</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">gkey</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">walk_groups</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">gkey</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs</span></div>



<div class="viewcode-block" id="grouped_weighted_avg">
<a class="viewcode-back" href="../../api/cmaqsatproc.utils.html#cmaqsatproc.utils.grouped_weighted_avg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">grouped_weighted_avg</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">by</span><span class="p">):</span>
    <span class="n">numerator</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
        <span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">wgb</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="p">)</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">wgb</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">simplemean</span> <span class="o">=</span> <span class="n">wgb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">wgb</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">outdf</span> <span class="o">=</span> <span class="n">numerator</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">denominator</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">outdf</span><span class="p">[</span><span class="s1">&#39;weight_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">denominator</span>
    <span class="n">outdf</span><span class="p">[</span><span class="s1">&#39;weight_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simplemean</span>
    <span class="n">outdf</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
    <span class="k">return</span> <span class="n">outdf</span></div>



<div class="viewcode-block" id="getcmrgranules">
<a class="viewcode-back" href="../../api/cmaqsatproc.utils.html#cmaqsatproc.utils.getcmrgranules">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">getcmrgranules</span><span class="p">(</span>
    <span class="n">temporal</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return all links from the Common Metadata Repository (CMR) for the product</span>
<span class="sd">    granules with short_name, date_range, and optionally a bounding box.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    temporal : str</span>
<span class="sd">        NASA temporal that is recognized by NASA CMR</span>
<span class="sd">        For example:</span>
<span class="sd">        - YYYY-MM-DDTHH:MM:SSZ or</span>
<span class="sd">        - YYYY-MM-DDTHH:MM:SSZ/YYYY-MM-DDTHH:MM:SSZ or</span>
<span class="sd">        - YYYY-MM-DDTHH:MM:SSZ/P01D (or P01M or P01Y, etc)</span>
<span class="sd">    bbox : list</span>
<span class="sd">        Longitude/latitude bounding edges as floats (wlon,slat,elon,nlat)</span>
<span class="sd">    poly : shapely.geometry.Polygon</span>
<span class="sd">        The exterior will be converted to floats and ordered x1,y1,...,xN,yN</span>
<span class="sd">    filterfunc : function</span>
<span class="sd">        Takes a link dictionary from CMR and returns True if it should be</span>
<span class="sd">        retained</span>
<span class="sd">    concept_id : str</span>
<span class="sd">        Optional, NASA concept_id that is the unique identifier for a</span>
<span class="sd">        collection in NASA&#39;s Common Metadata Repository</span>
<span class="sd">    short_name : str</span>
<span class="sd">        Optional, short_name identifier for a collection that is often, but</span>
<span class="sd">        not always unique in the NASA CMR. If you have the short_name and</span>
<span class="sd">        want the concept_id put the url below in your browser where you replace</span>
<span class="sd">        OMNO2 (the example) with your short_name</span>
<span class="sd">        https://cmr.earthdata.nasa.gov/search/collections?short_name=OMNO2</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    jr : dictionary</span>
<span class="sd">        json result as a dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;page_size&#39;</span><span class="p">,</span> <span class="s1">&#39;1000&#39;</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;pretty&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
    <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;temporal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temporal</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;concept_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;short_name&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">short_name</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;short_name&#39;</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;short_name not guaranteed unique. Try the concept_id keyword&#39;</span>
                <span class="o">+</span> <span class="s1">&#39; instead of short_name. Potential values for concept_id can&#39;</span>
                <span class="o">+</span> <span class="s1">&#39;  be found at: https://cmr.earthdata.nasa.gov/search/&#39;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;collections?short_name=</span><span class="si">{</span><span class="n">short_name</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;Queries are best with at least short_name and preferrably&#39;</span>
                <span class="o">+</span> <span class="s1">&#39; concept_id&#39;</span>
            <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;bounding_box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:f}</span><span class="s1">,</span><span class="si">{:f}</span><span class="s1">,</span><span class="si">{:f}</span><span class="s1">,</span><span class="si">{:f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">bbox</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">poly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">polygon</span>
        <span class="n">pgstr</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">orient</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">))</span>
        <span class="p">])</span>
        <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;polygon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgstr</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;https://cmr.earthdata.nasa.gov/search/granules.json&#39;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">opts</span>
    <span class="p">)</span>
    <span class="n">jr</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jr</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_isdownload</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="s1">&#39;opendap&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="p">(</span>
            <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;he5&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;h5&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;hdf&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_iss3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="s1">&#39;opendap&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="p">(</span>
            <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;he5&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;h5&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;hdf&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_isopendap</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="s1">&#39;opendap&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nc.html&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.he5.html&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h5.html&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.hdf.html&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>


<div class="viewcode-block" id="getcmrlinks">
<a class="viewcode-back" href="../../api/cmaqsatproc.utils.html#cmaqsatproc.utils.getcmrlinks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">getcmrlinks</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">filterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return all links from the Common Metadata Repository for the product</span>
<span class="sd">    granules with args and kwds passed thru to getcmrgranules</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    args, kwds :</span>
<span class="sd">        Passed to getcmrgranules as arguments and keywords (see getcmrgranules)</span>
<span class="sd">    filterfunc : function</span>
<span class="sd">        Takes a link dictionary from CMR and returns True if it should be</span>
<span class="sd">        retained</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    links : list</span>
<span class="sd">        List of all links where filterfunc is None or just links for which</span>
<span class="sd">        filterfunc returns True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filterfunc</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">filterfunc</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;download&#39;</span><span class="p">:</span> <span class="n">_isdownload</span><span class="p">,</span>
            <span class="s1">&#39;opendap&#39;</span><span class="p">:</span> <span class="n">_isopendap</span><span class="p">,</span>
            <span class="s1">&#39;s3&#39;</span><span class="p">:</span> <span class="n">_iss3</span>
        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filterfunc</span><span class="p">,</span> <span class="n">filterfunc</span><span class="p">)</span>
    <span class="n">jr</span> <span class="o">=</span> <span class="n">getcmrgranules</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">jr</span><span class="p">[</span><span class="s1">&#39;feed&#39;</span><span class="p">][</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">filterfunc</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]):</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">links</span></div>



<div class="viewcode-block" id="EasyDataFramePoint">
<a class="viewcode-back" href="../../api/cmaqsatproc.utils.html#cmaqsatproc.utils.EasyDataFramePoint">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">EasyDataFramePoint</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">xkey</span><span class="o">=</span><span class="s1">&#39;cn_x&#39;</span><span class="p">,</span> <span class="n">ykey</span><span class="o">=</span><span class="s1">&#39;cn_y&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thin wrapper on geopandas.points_from_xy. Create points from a rows with</span>
<span class="sd">    centers named xkey and ykey.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Must contain x, y</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    points : list</span>
<span class="sd">        List of shapely.geometry.Polygons</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">xkey</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">ykey</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">points</span></div>



<div class="viewcode-block" id="EasyDataFramePolygon">
<a class="viewcode-back" href="../../api/cmaqsatproc.utils.html#cmaqsatproc.utils.EasyDataFramePolygon">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">EasyDataFramePolygon</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lowmem</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create polygons from a row with corners of a pixel specificied using</span>
<span class="sd">    columns ll_x, ll_y ... uu_x, uu_y.</span>

<span class="sd">    The wrap functionality prevents polygons from straddling the dateline.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Must contain ll, lu, uu, ul for x and y (e.g., ll_x, ll_y)</span>
<span class="sd">    wrap : bool</span>
<span class="sd">        If True (default), each polygon that crosses the dateline will be</span>
<span class="sd">        truncated to the Western portion.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    polys : list</span>
<span class="sd">        List of shapely.geometry.Polygons</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">_xcrnrkeys</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">_ycrnrkeys</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Conceivably apply the same approach to the pole</span>
    <span class="c1"># dy = y.max(axis=1) - y.min(axis=1)</span>
    <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
        <span class="n">newx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="p">((</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="o">-</span><span class="mi">180</span><span class="p">)</span>
        <span class="n">newy</span> <span class="o">=</span> <span class="n">y</span>  <span class="c1"># .where(~((dy &gt; 45).values[:, None] &amp; (y &lt; 0).values), 90)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newx</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">newy</span> <span class="o">=</span> <span class="n">y</span>

    <span class="n">polys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Faster to convert all to values arrays first</span>
    <span class="k">if</span> <span class="n">lowmem</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">newx</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">newx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">8.3%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">newy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">newx</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">newy</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xys</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">8.3%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">xy</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">100.000%&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">polys</span></div>



<div class="viewcode-block" id="rootremover">
<a class="viewcode-back" href="../../api/cmaqsatproc.utils.html#cmaqsatproc.utils.rootremover">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rootremover</span><span class="p">(</span><span class="n">strlist</span><span class="p">,</span> <span class="n">insert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the longest common root and replace it with {root}</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    strlist : list</span>
<span class="sd">        List of strings from which to find a common root and replace with</span>
<span class="sd">        &#39;{root}&#39;</span>
<span class="sd">    insert : bool</span>
<span class="sd">        If true, insert f&#39;root: {root}&#39; at the beginning of the short list.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    stem, short_list</span>
<span class="sd">        List with each element of strlist where the longest common root has</span>
<span class="sd">        been removed. If insert, then the root is inserted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

    <span class="n">stem</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">strlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">stem</span> <span class="ow">in</span> <span class="n">_l</span> <span class="k">for</span> <span class="n">_l</span> <span class="ow">in</span> <span class="n">strlist</span><span class="p">])</span> <span class="ow">or</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">oldstem</span> <span class="o">=</span> <span class="n">stem</span>
        <span class="n">stem</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">stem</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oldstem</span> <span class="o">==</span> <span class="n">stem</span><span class="p">:</span>
            <span class="n">short_strlist</span> <span class="o">=</span> <span class="n">strlist</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">short_strlist</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{root}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_l</span> <span class="ow">in</span> <span class="n">strlist</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">insert</span><span class="p">:</span>
            <span class="n">short_strlist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;root: </span><span class="si">{</span><span class="n">stem</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stem</span><span class="p">,</span> <span class="n">short_strlist</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">coord_interp</span><span class="p">(</span>
    <span class="n">coordout</span><span class="p">,</span> <span class="n">coordin</span><span class="p">,</span> <span class="n">varin</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span>
    <span class="n">outdim</span><span class="o">=</span><span class="s1">&#39;LAY&#39;</span><span class="p">,</span> <span class="n">indim</span><span class="o">=</span><span class="s1">&#39;LAY&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    coordout : xarray.DataArray</span>
<span class="sd">        n-dimensional (must have outdim) where values of coordout are the</span>
<span class="sd">        coordinate</span>
<span class="sd">    coordin : xarray.DataArray</span>
<span class="sd">        n-dimensional (must have indim) where values of coordin are the</span>
<span class="sd">        coordinate</span>
<span class="sd">    varin : xarray.DataArray</span>
<span class="sd">        n-dimensional (must have indim) where values will be interpolated</span>
<span class="sd">    **kwds : mappable</span>
<span class="sd">        supplied as keywords to numpy interp</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : xarray.DataArray</span>
<span class="sd">        varin interpolated to coordout</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

    <span class="k">if</span> <span class="n">interp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">interp1d</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">interp1d</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="n">tempdimname</span> <span class="o">=</span> <span class="s1">&#39;temp_dim_name&#39;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">coordout</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">outdim</span><span class="p">:</span> <span class="n">tempdimname</span><span class="p">})</span>
    <span class="n">XP</span> <span class="o">=</span> <span class="n">coordin</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">indim</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">)</span>
    <span class="n">FP</span> <span class="o">=</span> <span class="n">varin</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">indim</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">)</span>
    <span class="n">interped</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
        <span class="n">interp1d</span><span class="p">,</span>
        <span class="n">FP</span><span class="p">,</span>
        <span class="n">XP</span><span class="p">,</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="n">indim</span><span class="p">],</span> <span class="p">[</span><span class="n">indim</span><span class="p">],</span> <span class="p">[</span><span class="n">tempdimname</span><span class="p">]],</span>
        <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="n">tempdimname</span><span class="p">]],</span>
        <span class="n">exclude_dims</span><span class="o">=</span><span class="nb">set</span><span class="p">((</span><span class="n">indim</span><span class="p">,)),</span>
        <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="n">kwds</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">interped</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">tempdimname</span><span class="p">:</span> <span class="n">outdim</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">out</span>


<div class="viewcode-block" id="cdconvert">
<a class="viewcode-back" href="../../api/cmaqsatproc.utils.html#cmaqsatproc.utils.cdconvert">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cdconvert</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span> <span class="n">inunit</span><span class="p">,</span> <span class="n">outunit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts between du, mole m**-2, and molecules cm**-2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">inunit</span> <span class="o">=</span> <span class="n">inunit</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;**&#39;</span><span class="p">)</span>
    <span class="n">outunit</span> <span class="o">=</span> <span class="n">outunit</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;**&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inunit</span> <span class="o">==</span> <span class="n">outunit</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inval</span>
    <span class="k">elif</span> <span class="n">inunit</span> <span class="o">==</span> <span class="s1">&#39;du&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outunit</span> <span class="o">==</span> <span class="s1">&#39;mole m**-2&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inval</span> <span class="o">/</span> <span class="mf">1e5</span> <span class="o">*</span> <span class="mi">101325</span> <span class="o">/</span> <span class="mf">8.314</span> <span class="o">/</span> <span class="mf">273.15</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cdconvert</span><span class="p">(</span>
                <span class="n">cdconvert</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span> <span class="n">inunit</span><span class="p">,</span> <span class="s1">&#39;mole m**-2&#39;</span><span class="p">),</span> <span class="s1">&#39;mole m**-2&#39;</span><span class="p">,</span> <span class="n">outunit</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">inunit</span> <span class="o">==</span> <span class="s1">&#39;molecules cm**-2&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outunit</span> <span class="o">==</span> <span class="s1">&#39;mole m**-2&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inval</span> <span class="o">/</span> <span class="mf">6.022e23</span> <span class="o">*</span> <span class="mf">1e4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cdconvert</span><span class="p">(</span>
                <span class="n">cdconvert</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span> <span class="n">inunit</span><span class="p">,</span> <span class="s1">&#39;mole m**-2&#39;</span><span class="p">),</span> <span class="s1">&#39;mole m**-2&#39;</span><span class="p">,</span> <span class="n">outunit</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">inunit</span> <span class="o">==</span> <span class="s1">&#39;mole m**-2&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outunit</span> <span class="o">==</span> <span class="s1">&#39;du&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inval</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">1e5</span> <span class="o">*</span> <span class="mi">101325</span> <span class="o">/</span> <span class="mf">8.314</span> <span class="o">/</span> <span class="mf">273.15</span><span class="p">)</span><span class="o">**-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">outunit</span> <span class="o">==</span> <span class="s1">&#39;molecules cm**-2&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inval</span> <span class="o">*</span> <span class="mf">6.022e23</span> <span class="o">/</span> <span class="mf">1e4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;unknown outunit (</span><span class="si">{</span><span class="n">outunit</span><span class="si">}</span><span class="s1">); use du, mole m**-2, or&#39;</span>
                <span class="o">+</span> <span class="s1">&#39; molecules cm**-2&#39;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;unknown inunit (</span><span class="si">{</span><span class="n">inunit</span><span class="si">}</span><span class="s1">); use du, mole m**-2, or&#39;</span>
            <span class="o">+</span> <span class="s1">&#39; molecules cm**-2&#39;</span>
        <span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    url : str</span>
<span class="sd">        url to download</span>
<span class="sd">    dest : str or None</span>
<span class="sd">        Destination for downloaded file.</span>
<span class="sd">        If None, defaults to url&#39;s server and path</span>
<span class="sd">    check : str</span>
<span class="sd">        Do not download if:</span>
<span class="sd">        - &#39;exists&#39; : the destination exists</span>
<span class="sd">        - &#39;size&#39; : the destination file matches the response&#39;s</span>
<span class="sd">                   Content-Length</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dest : str</span>
<span class="sd">        Local path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
    <span class="k">assert</span> <span class="n">check</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO:: downloading&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span> <span class="o">+</span> <span class="n">parsed</span><span class="o">.</span><span class="n">path</span>
    <span class="k">if</span> <span class="n">check</span> <span class="o">==</span> <span class="s1">&#39;exists&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO:: cached&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dest</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># get content size</span>
    <span class="k">if</span> <span class="n">check</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
        <span class="n">nbytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nbytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARN:: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1"> content length unknown; redownloading&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span> <span class="o">==</span> <span class="n">nbytes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARN:: cached&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dest</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;ERROR:: status code 401!&#39;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; Missing valid authentication credentials&#39;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; Ensure your ~/.netrc file has valid user and password&#39;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; for </span><span class="si">{</span><span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="si">}</span><span class="s1"> or urs.earthdata.nasa.gov&#39;</span>
        <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR:: Failed to download. Status code: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dest</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">cmaqsatproc</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Users Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">Example Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/cmaqsatproc.html">cmaqsatproc package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023, Barron H. Henderson.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 9.1.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>